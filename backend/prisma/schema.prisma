generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int       @id @default(autoincrement())
  email               String    @unique
  password_hash       String
  name                String?
  role                String    // 'admin', 'staff', 'parent'
  linked_student_id   Int?
  linked_student_udid String?   // UDID of linked student (required for parents)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt
  
  uploads           Document[]
  record_versions   RecordVersion[]
}

model Student {
  id                Int       @id @default(autoincrement())
  udid              String    @unique @default(uuid()) // System-generated unique identifier
  ipp_number        String    @unique
  name              String
  dob               DateTime
  gender            String?
  blood_group       String?
  height            String?   // Height in cm
  weight            String?   // Weight in kg
  address           String?
  center_name       String?   @default("V-Excel Foundation") // Center/facility name
  parent_names      String?
  parent_contact    String?
  parent_email      String?   // Parent/guardian email ID
  disability_type   String?
  disability_detail String?   // Specific details about disability
  clinical_case_no  String?   // Unique case identifier
  therapist_assigned String?  // Assigned therapist name
  referral_doctor   String?
  // Attendance tracking
  days_present      Int       @default(0)   // Number of days present
  days_absent       Int       @default(0)   // Number of days absent
  total_working_days Int      @default(0)   // Total working days
  attendance        Int       @default(100) // Attendance percentage (0-100) - auto-calculated or manual
  quick_notes       String?   // Additional notes about the student
  active_status     Boolean   @default(true)
  public_link_token String    @unique @default(uuid()) // Secure token for public emergency dashboard
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  documents         Document[]
  clinical_history  ClinicalHistory?
  milestones        DevelopmentalMilestones?
  adl               DailyLivingSkills?
  observations      ClinicalObservations?
}


model Document {
  id                Int       @id @default(autoincrement())
  student           Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  student_id        Int
  filename          String
  file_path         String
  type              String    // 'screening', 'monthly', 'quarterly', 'iep'
  uploader          User      @relation(fields: [uploaded_by], references: [id])
  uploaded_by       Int
  status            String    @default("pending") // 'pending', 'processed', 'error'
  extracted_data    String?   // JSON string in SQLite
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
}

model RecordVersion {
  id                Int       @id @default(autoincrement())
  entity_type       String    // 'clinical_history', 'milestones', etc.
  entity_id         Int
  version_number    Int
  data              String    // JSON string
  changed_by_user   User      @relation(fields: [changed_by], references: [id])
  changed_by        Int
  change_reason     String?
  created_at        DateTime  @default(now())
}

model ClinicalHistory {
  id                    Int       @id @default(autoincrement())
  student               Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  student_id            Int       @unique
  siblings_details      String?
  family_structure      String?
  home_language         String?
  consanguinity         Boolean   @default(false)
  pregnancy_duration    String?
  delivery_nature       String?
  birth_weight          String?
  birth_cry             String?
  history_seizures      Boolean   @default(false)
  history_respiratory   Boolean   @default(false)
  current_medications   String?
  allergies             String?
  age_disability_noticed String?
  updated_at            DateTime  @updatedAt
}

model DevelopmentalMilestones {
  id                Int       @id @default(autoincrement())
  student           Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  student_id        Int       @unique
  social_smile      String?
  neck_control      String?
  sitting           String?
  crawling          String?
  standing          String?
  walking           String?
  speech_initiation String?
  updated_at        DateTime  @updatedAt
}

model DailyLivingSkills {
  id                Int       @id @default(autoincrement())
  student           Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  student_id        Int       @unique
  eating            String?
  dressing          String?
  toileting         String?
  updated_at        DateTime  @updatedAt
}

model ClinicalObservations {
  id                      Int       @id @default(autoincrement())
  student                 Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)
  student_id              Int       @unique
  general_appearance      String?
  psychomotor_skills      String?
  sensory_issues          String?
  cognition_memory        String?
  communication_expressive String?
  communication_receptive  String?
  social_interaction      String?
  updated_at              DateTime  @updatedAt
}

model Event {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  date        DateTime
  location    String?
  type        String    @default("meeting") // 'meeting', 'workshop', 'holiday'
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

